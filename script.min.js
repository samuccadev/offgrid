"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("sw.js").then(e=>console.log("ServiceWorker registrado com sucesso: ",e.scope)).catch(e=>console.log("Falha ao registrar ServiceWorker: ",e))});let appliances=[],currentListName="",welcomeScreen=document.getElementById("welcomeScreen"),appContent=document.getElementById("appContent"),savedListsContainer=document.getElementById("savedListsContainer"),savedLists=document.getElementById("savedLists"),appliancesList=document.getElementById("appliancesList"),appliancesCardsList=document.getElementById("appliancesCardsList"),totalConsumptionSpan=document.getElementById("totalConsumption"),totalConsumptionConfig=document.getElementById("totalConsumptionConfig"),totalConsumptionResults=document.getElementById("totalConsumptionResults");function gerarPDF(){var e=Object.keys(localStorage).find(e=>e.startsWith("solarList_"));e?(preencherTemplatePDF(JSON.parse(localStorage.getItem(e)),e),gerarPDFFromTemplate()):alert("Nenhuma lista salva encontrada! Adicione aparelhos e calcule o sistema primeiro.")}function preencherTemplatePDF(e,t){document.getElementById("pdf-date").textContent=(new Date).toLocaleString("pt-BR"),document.getElementById("pdf-list-name").textContent=t.replace("solarList_",""),document.getElementById("pdf-creation-date").textContent=(new Date).toLocaleDateString("pt-BR"),document.getElementById("pdf-total-appliances").textContent=e.appliances.length;t=e.appliances.reduce((e,t)=>e+t.dailyConsumption,0);document.getElementById("pdf-total-consumption").textContent=t.toFixed(2)+" Wh/dia",document.getElementById("pdf-autonomy").textContent=e.config.autonomy,document.getElementById("pdf-system-voltage").textContent=e.config.systemVoltage,document.getElementById("pdf-battery-type").textContent="leadAcid"===e.config.batteryType?"Chumbo Ácido":"LiFePO4",document.getElementById("pdf-battery-capacity").textContent=e.config.batteryUnitCapacity,document.getElementById("pdf-discharge-depth").textContent=e.config.dischargeDepth,document.getElementById("pdf-battery-efficiency").textContent=e.config.batteryEfficiency,document.getElementById("pdf-sun-hours").textContent=e.config.sunHours,document.getElementById("pdf-panel-power").textContent=e.config.panelPower;let a=document.getElementById("pdf-appliances-list");a.innerHTML="",e.appliances.forEach(e=>{var t=document.createElement("tr");t.innerHTML=`
            <td>${e.name}</td>
            <td>${e.quantity}</td>
            <td>${e.power} W</td>
            <td>${e.hours} h</td>
            <td>${e.dailyConsumption.toFixed(2)} Wh</td>
        `,a.appendChild(t)}),document.getElementById("pdf-appliances-total").textContent=t.toFixed(2)+" Wh/dia",document.getElementById("pdf-total-consumption-result").textContent=t.toFixed(2)+" Wh/dia";var n=t*(1+(e.config.systemLosses||10)/100),o=(document.getElementById("pdf-required-generation").textContent=n.toFixed(2)+" Wh/dia",e.config.panelPower||330),s=e.config.sunHours||5,n=Math.ceil(n/(o*s)),s=(document.getElementById("pdf-solar-panels").textContent=n+" unidades",e.config.systemVoltage||24),n=n*o/s,o=(document.getElementById("pdf-charge-controller").textContent=n.toFixed(1)+" A",e.config.batteryUnitCapacity||200),n=e.config.autonomy||2,i=e.config.dischargeDepth||50,e=e.config.batteryEfficiency||85,n=Math.ceil(t*n/(s*(i/100)*(e/100))/o),d=s/12,l=n*d,d=(document.getElementById("pdf-battery-config").textContent=d+`s${n}p`,document.getElementById("pdf-battery-quantity").textContent=l+" unidades",o*n*s*(i/100)*(e/100)/t);document.getElementById("pdf-battery-autonomy").textContent=d.toFixed(1)+" dias",document.getElementById("pdf-battery-capacity-total").textContent=(o*n).toFixed(0)+" Ah"}function gerarPDFFromTemplate(){let i=document.getElementById("pdf-template");i.style.display="block",html2canvas(i,{scale:2,useCORS:!0,logging:!1}).then(e=>{i.style.display="none";var t=e.toDataURL("image/png"),a=new jspdf.jsPDF({orientation:"portrait",unit:"mm",format:"a4"}),n=210*e.height/e.width;let o=n;var s;for(a.addImage(t,"PNG",0,0,210,n),o-=297;0<=o;)s=o-n,a.addPage(),a.addImage(t,"PNG",0,s,210,n),o-=297;a.save("relatorio_sistema_solar.pdf")})}function showWelcomeScreen(){welcomeScreen.style.display="flex",appContent.style.display="none",savedListsContainer.style.display="none"}function calculateChargeController(e,t,a,n=1.25){return e*t/a*n}function calculateBatterySystem(e,t,a,n,o,s){var t=e*t/(a*(n/100)*(o/100)),i=Math.ceil(t/s),d=a/12,s=i*s,a=s*a;return{capacidadeTotalAh:t,quantidadeBateriasParalelo:i,bateriasSerie:d,quantidadeTotalBaterias:i*d,capacidadeRealAh:s,capacidadeRealWh:a,autonomiaReal:n/100*a*(o/100)/e}}function updateVoltageRecommendation(e,t){var a=e/12,n=e/24,e=e/48;function o(e,t){e=document.getElementById(e);e&&(e.textContent=t)}o("currentAmps12V",a.toFixed(0)+"A"),o("currentAmps24V",n.toFixed(0)+"A"),o("currentAmps48V",e.toFixed(0)+"A");n=estimateCableSize(a),a=estimateCableSize(e);o("cableSize12V",n+"mm²"),o("cableSize48V",a+"mm²")}function estimateCableSize(e){return 300<e?300:200<e?150:100<e?70:50<e?35:30<e?25:16}function showVoltageRecommendationSimple(a,n){var o=document.getElementById("voltageRecommendation");if(o){var s=a/12*1.25,i=a/24*1.25,d=a/48*1.25;let e=12,t="";t=5e3<a?(e=48,"Sistema de alta potência (>5000W)"):2400<a?(e=48,"Sistema de média potência (2400-5000W)"):1200<a?(e=24,"Sistema de média potência (1200-2400W)"):(e=12,"Sistema de baixa potência (<1200W)");var l=n===e;o.innerHTML=`
    <div class="card border mb-4">
        <div class="card-header bg-light text-dark border-bottom">
            <h5 class="mb-0"><i class="fas fa-bolt me-2" style="color: #FFA500;"></i>Recomendação de Tensão do Sistema</h5>
        </div>
        <div class="card-body">
            ${l?`
            <div class="alert alert-success mb-3">
                <strong><i class="fas fa-check-circle me-1"></i> Tensão atual (${n}V) está adequada</strong>
                <p class="mb-0 mt-1">${t}</p>
            </div>
            `:`
            <div class="alert alert-warning mb-3" style="background-color: #FFF3CD; border-color: #FFA500;">
                <strong><i class="fas fa-info-circle me-1" style="color: #FFA500;"></i> Tensão atual (${n}V) pode ser otimizada</strong>
                <p class="mb-0 mt-1">Recomendado: ${e}V - ${t}</p>
            </div>
            `}
            
            <div class="row text-center g-3">
                <div class="col-4">
                    <div class="border rounded p-2 ${12===n?"bg-warning":"bg-light"}">
                        <h6 class="text-dark">12V</h6>
                        <h4 class="text-dark">${s.toFixed(0)}A</h4>
                        <span class="badge ${12===n?"bg-warning text-dark":"bg-secondary"}">${12===n?"Atual":"12V"}</span>
                    </div>
                </div>
                <div class="col-4">
                    <div class="border rounded p-2 ${24===n?"bg-warning":"bg-light"}">
                        <h6 class="text-dark">24V</h6>
                        <h4 class="text-dark">${i.toFixed(0)}A</h4>
                        <span class="badge ${24===n?"bg-warning text-dark":"bg-secondary"}">${24===n?"Atual":"24V"}</span>
                    </div>
                </div>
                <div class="col-4">
                    <div class="border rounded p-2 ${48===n?"bg-success text-white":"bg-light"}">
                        <h6 class="${48===n?"text-white":"text-dark"}">48V</h6>
                        <h4 class="${48===n?"text-white":"text-dark"}">${d.toFixed(0)}A</h4>
                        <span class="badge ${48===n?"bg-light text-success":"bg-secondary"}">${48===n?"Atual":"48V"}</span>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-warning mt-3 mb-0" style="background-color: #FFF3CD; border-color: #FFA500;">
                <strong><i class="fas fa-lightbulb me-1" style="color: #FFA500;"></i> Benefícios com ${e}V:</strong> 
                <p class="mb-0 mt-1">Redução de corrente de ${s.toFixed(0)}A para ${(a/e*1.25).toFixed(0)}A 
                (${(s/(a/e*1.25)).toFixed(1)}x menor)</p>
            </div>
        </div>
    </div>
`}}function updateSystemResults(){if(0!==appliances.length){let a=parseInt(document.getElementById("autonomy").value),n=parseInt(document.getElementById("systemVoltage").value);var e=parseInt(document.getElementById("batteryEfficiency").value);let o=parseInt(document.getElementById("dischargeDepth").value),s=parseFloat(document.getElementById("sunHours").value),i=parseFloat(document.getElementById("panelPower").value);var t=document.getElementById("batteryType").value,d=parseFloat(document.getElementById("batteryUnitCapacity").value),l=parseFloat(document.getElementById("systemLosses").value),t="leadAcid"===t?"Chumbo Ácido":"LiFePO4",c=appliances.reduce((e,t)=>e+t.dailyConsumption,0),r=c+c*(l/100),m=r/(i*s),p=Math.ceil(m),u=(showVoltageRecommendationSimple(p*i,n),calculateChargeController(p,i,n)),e=calculateBatterySystem(c,a,n,o,e,d),c=(document.getElementById("totalDailyConsumption").textContent=c.toFixed(2)+" Wh/dia",document.getElementById("geracaoNecessaria").textContent=r.toFixed(2)+" Wh/dia",document.getElementById("placaNecessarias").textContent=m.toFixed(2)+"  unidades",document.getElementById("chargeController").textContent=u.toFixed(1)+" A",document.getElementById("solarPanels").textContent=p+"  unidades",document.getElementById("batteryConfig").textContent=`${e.bateriasSerie}s${e.quantidadeBateriasParalelo}p`,document.getElementById("batteryConfigDetail").textContent=`${n}V × ${e.capacidadeRealAh}Ah`,document.getElementById("batteryCapacity").textContent=e.capacidadeTotalAh.toFixed(2)+" Ah",document.getElementById("batteryCapacityWh").textContent=e.capacidadeRealWh.toLocaleString("pt-BR")+" Wh",document.getElementById("quantidadeBaterias").textContent=e.quantidadeTotalBaterias+" unidades",document.getElementById("batteryAutonomy").textContent=e.autonomiaReal.toFixed(1)+" dias",document.getElementById("autonomyHours").textContent=Math.round(24*e.autonomiaReal)+" horas",document.getElementById("batteryConfigExplanation").textContent=`${e.bateriasSerie} baterias em série × ${e.quantidadeBateriasParalelo} em paralelo`,document.getElementById("batteryUnitInfo").textContent=d+"Ah cada",["autonomyDays","dischargePercent","sunHoursValue","panelPowerValue","tensaoSistema"].forEach(e=>{var t=document.getElementById(e);t&&(t.textContent={autonomyDays:a,dischargePercent:o,sunHoursValue:s,panelPowerValue:i,tensaoSistema:n}[e])}),document.getElementById("batteryUnitCapacityText")),r=(c&&(c.textContent=d),document.getElementById("systemLossPercent")),m=(r&&(r.textContent=l.toFixed(1)),document.getElementById("batteryTypeResult"));m&&(m.textContent=t)}}function updateAppliancesList(){appliancesList.innerHTML="",appliancesCardsList.innerHTML="";let i=0;0===appliances.length?(e=`
                <tr><td colspan="6" class="text-center py-4">
                    <i class="fas fa-inbox fs-2"></i>
                    <p class="mt-2 mb-0">Nenhum aparelho adicionado</p>
                </td></tr>`,appliancesList.innerHTML=e,appliancesCardsList.innerHTML=e):appliances.forEach((e,t)=>{i+=e.dailyConsumption;var a=document.createElement("tr"),n=(a.innerHTML=`
                    <td>${e.name}</td>
                    <td>${e.quantity}</td>
                    <td>${e.power} W</td>
                    <td>${e.hours} h</td>
                    <td>${e.dailyConsumption.toFixed(2)} Wh</td>
                    <td>
                        <div class="d-flex gap-1"></div>
                    </td>`,a.querySelector("td:last-child div")),o=document.createElement("button"),s=(o.className="btn btn-sm btn-warning",o.innerHTML='<i class="fas fa-edit"></i>',o.addEventListener("click",()=>editAppliance(t)),document.createElement("button")),o=(s.className="btn btn-sm btn-danger",s.innerHTML='<i class="fas fa-trash"></i>',s.addEventListener("click",()=>removerAparelho(t)),n.appendChild(o),n.appendChild(s),appliancesList.appendChild(a),document.createElement("div")),n=(o.className="card mb-3 p-3",o.innerHTML=`
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">${e.name}</h6>
                        <span class="badge bg-primary">${e.quantity}x</span>
                    </div>
                    <div>Potência: ${e.power} W</div>
                    <div>Horas/dia: ${e.hours} h</div>
                    <div>Consumo: <strong>${e.dailyConsumption.toFixed(2)} Wh/dia</strong></div>
                    <div class="d-flex gap-2 mt-2"></div>`,o.querySelector(".d-flex.gap-2")),s=document.createElement("button"),a=(s.className="btn btn-sm btn-warning w-50",s.innerHTML='<i class="fas fa-edit me-1"></i> Editar',s.addEventListener("click",()=>editAppliance(t)),document.createElement("button"));a.className="btn btn-sm btn-danger w-50",a.innerHTML='<i class="fas fa-trash me-1"></i> Remover',a.addEventListener("click",()=>removerAparelho(t)),n.appendChild(s),n.appendChild(a),appliancesCardsList.appendChild(o)});var e=i.toFixed(2)+" Wh/dia";totalConsumptionSpan.textContent=e,totalConsumptionConfig.textContent=e,totalConsumptionResults.textContent=e,document.getElementById("totalKwh").textContent=i.toFixed(2),document.getElementById("totalKwhMobile").textContent=e,document.getElementById("totalAparelhos").textContent=appliances.length,document.getElementById("totalAparelhosMobile").textContent=appliances.length,updateSystemResults()}function startNewCalculation(){appliances=[],currentListName="Nova Lista",salvarListaAtual()}function showSavedLists(){savedListsContainer.style.display="block",renderSavedLists()}function hideSavedLists(){savedListsContainer.style.display="none"}function renderSavedLists(){savedLists.innerHTML="";let o=!1;Object.keys(localStorage).forEach(a=>{if(a.startsWith("solarList_")){o=!0;let t=a.replace("solarList_",""),e=JSON.parse(localStorage.getItem(a));var n=document.createElement("div");n.className="saved-list-item p-3 border rounded mb-2 d-flex justify-content-between align-items-center",n.innerHTML=`
                <div class="me-2">
                    <h5 class="mb-1">${t}</h5>
                    <p class="mb-1">${e.appliances.length} aparelhos</p>
                    <small>Consumo: ${calculateTotalConsumption(e.appliances).toFixed(2)} Wh/dia</small>
                </div>
                <button class="btn btn-sm btn-danger delete-list">
                    <i class="fas fa-trash"></i>
                </button>
            `,n.addEventListener("click",()=>loadSavedList(t,e)),n.querySelector(".delete-list").addEventListener("click",e=>{e.stopPropagation(),confirm(`Deseja excluir a lista "${t}"?`)&&(localStorage.removeItem(a),renderSavedLists())}),savedLists.appendChild(n)}}),o||(savedLists.innerHTML=`
            <div class="text-center py-4">
                <i class="fas fa-inbox fs-2"></i>
                <p class="mt-2 mb-0">Nenhuma lista salva</p>
            </div>
        `)}function calculateTotalConsumption(e){return e.reduce((e,t)=>e+t.dailyConsumption,0)}function loadSavedList(e,t){appliances=t.appliances,currentListName=e,t.config&&(Object.entries(t.config).forEach(([e,t])=>{e=document.getElementById(e);e&&(e.value=t)}),document.getElementById("batteryType").dispatchEvent(new Event("change")));e=document.getElementById("batteryUnitCapacityText");e&&t.config.batteryUnitCapacity&&(e.textContent=t.config.batteryUnitCapacity),welcomeScreen.style.display="none",appContent.style.display="block",updateAppliancesList(),toggleResultsSection(),0<appliances.length&&document.getElementById("calculateBtn").click()}function showTab(e){document.querySelectorAll(".tab-pane").forEach(e=>e.classList.remove("show","active")),document.getElementById(e).classList.add("show","active"),window.scrollTo(0,0)}window.gerarPDF=gerarPDF,document.addEventListener("DOMContentLoaded",()=>{showWelcomeScreen();let i=document.getElementById("applianceForm");var e=document.getElementById("calculateBtn");document.getElementById("resultsSection"),document.getElementById("emptyState");let t=document.getElementById("batteryType"),a=document.getElementById("dischargeDepth"),n=document.getElementById("batteryEfficiency"),d=document.getElementById("editIndex"),o={leadAcid:{dischargeDepth:50,efficiency:85},lifepo4:{dischargeDepth:80,efficiency:95}};function s(){var e={autonomy:parseInt(document.getElementById("autonomy").value),systemVoltage:parseInt(document.getElementById("systemVoltage").value),batteryType:document.getElementById("batteryType").value,batteryUnitCapacity:parseInt(document.getElementById("batteryUnitCapacity").value),dischargeDepth:parseInt(document.getElementById("dischargeDepth").value),batteryEfficiency:parseInt(document.getElementById("batteryEfficiency").value),systemLosses:parseFloat(document.getElementById("systemLosses").value),sunHours:parseFloat(document.getElementById("sunHours").value),panelPower:parseFloat(document.getElementById("panelPower").value)},e={appliances:appliances,config:e};localStorage.setItem("solarList_"+currentListName,JSON.stringify(e))}t.addEventListener("change",()=>{var e=o[t.value];a.value=e.dischargeDepth,n.value=e.efficiency}),i.addEventListener("submit",e=>{e.preventDefault();var t,e=document.getElementById("applianceName").value,a=parseInt(document.getElementById("quantity").value),n=parseFloat(document.getElementById("power").value),o=parseFloat(document.getElementById("hours").value),s=parseInt(d.value);e&&a&&n&&o&&(t=a*n*o,-1===s?appliances.push({name:e,quantity:a,power:n,hours:o,dailyConsumption:t}):(appliances[s]={name:e,quantity:a,power:n,hours:o,dailyConsumption:t},s=document.getElementById("submitButton"),d.value="-1",s.innerHTML='<i class="fas fa-plus me-1"></i> Adicionar',i.reset(),document.getElementById("quantity").value=1),updateAppliancesList(),i.reset(),document.getElementById("quantity").value=1,toggleResultsSection())}),window.toggleResultsSection=()=>{var e=document.getElementById("resultsSection"),t=document.getElementById("emptyState");0===appliances.length?(e&&(e.style.display="none"),t&&(t.style.display="block")):(e&&(e.style.display="block"),t&&(t.style.display="none")),currentListName&&s()},window.editAppliance=e=>{var t=document.getElementById("submitButton"),a=document.getElementById("editIndex"),n=appliances[e];document.getElementById("applianceName").value=n.name,document.getElementById("quantity").value=n.quantity,document.getElementById("power").value=n.power,document.getElementById("hours").value=n.hours,a.value=e,t.innerHTML='<i class="fas fa-save me-1"></i> Atualizar',i.scrollIntoView({behavior:"smooth"}),window.innerWidth<=768&&showTab("appliances")},window.removerAparelho=e=>{confirm("Tem certeza que deseja remover este aparelho?")&&(appliances.splice(e,1),updateAppliancesList(),s(),toggleResultsSection())},e.addEventListener("click",()=>{if(0===appliances.length)return alert("Adicione pelo menos um aparelho para calcular o sistema.");updateSystemResults(),window.innerWidth<=768&&showTab("results"),s()}),window.salvarListaAtual=()=>{var e=prompt("Digite um nome para a lista:",currentListName);e&&(s(),currentListName=e,welcomeScreen.style.display="none",appContent.style.display="block",updateAppliancesList(),toggleResultsSection())},updateAppliancesList(),toggleResultsSection()});